<html>
    <title>Small Multiples by OneTandem</title>
    <head>
        <meta name="author" content="Victor Pascual">
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <style>
            .chart {
                float: left;
                padding-right: 5px;
                padding-bottom: 5px;
                padding-top: 0;
                padding-bottom: 0;
                border: 1px solid #eee;
            }

            .background {
                fill: white;
            }

            .area {
                fill: #cec6b9;
            }

            .line {
                fill: none;
                stroke: #74736c;
                stroke-width: 1.4px;
            }
        </style>
    </head>
    <body>
        <div id='vis'></div>
        <script>
            var width = 200,
                height = 200,
                margin = {top: 20, bottom: 20, left: 20, right: 20};

            d3.tsv("danceability.tsv", function(rawData) {
                console.log(rawData);
                rawData.forEach((d) => {
                   d.danceability = +d.danceability;
                   d.value = d.value.replace(',', '.');
                   d.value = +d.value;
                });

                var maxDancebility = d3.max(rawData, (d) => { return d.value; }) * 1.1;
                console.log(maxDancebility)

                data = d3.nest()
                    .key(function(d) { return d.band; })
                    .sortValues((a, b) => {
                        return d3.ascending(a.danceability, b.danceability);
                    })
                    .entries(rawData);

                var div = d3.select("#vis")
                    .selectAll(".chart")
                    .data(data);

                var svg = div.enter()
                    .append('div')
                    .attr('class', (d) => { console.log(d); return 'chart'})
                    .append('svg')
                        .attr('width', width + margin.left + margin.top)
                        .attr('height', height + margin.top + margin.bottom);
                    
                var g = svg.append('g')
                    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

                g.append('rect')
                    .attr('class', 'background')
                    .style('pointer-events', 'all')
                    .attr('width', width + margin.right)
                    .attr('height', height)
                    .on("mouseover", mouseover)
                    .on("mousemove", mousemove)
                    .on("mouseout", mouseout);

                var xScale = d3.scaleLinear().range([0, width]);
                var yScale = d3.scaleLinear().range([height, 0]).domain([0, maxDancebility]);

                var line = d3.line()
                    .x(function(d) { return xScale(d.danceability); })
                    .y(function(d) { return yScale(d.value); });

                var area = d3.area()
                    .x(function(d) { 
                        return xScale(d.danceability); })
                    .y0(height).y1(function(d) { 
                        return yScale(d.value); });

                lines = g.append("g");

                lines.append("path")
                    .attr("class", "area")
                    .attr("d", function(c) {
                        return area(c.values);
                    });

                lines.append("path")
                    .attr("class", "line")
                    .attr("d", function(c) {
                        return line(c.values);
                    });

               // hide for now
                circle = lines.append("circle")
                    .attr("r", 2.2)
                    .attr("opacity", 0);

                var mouseover = () => {
                    circle.attr("opacity", 1.0);
                    return mousemove.call(this);
                };

                var mouseout = () => {
                    circle.attr("opacity", 0);
                    return true;
                };

                var mousemove = function() {
                    console.log("mouse moveee!")
                    // 'this' is current DOM element
                    var xpos = d3.mouse(this)[0];
                    var xBar = xScale.invert(xpos);
                    var index = 0;

                    circle
                        .attr("cx", xScale(xBar))
                        .attr("cy", (c) => {
                            // index = findIndex(c.values, xBar);
                            index = bisect(c.values, xBar, 0, c.values.length - 1);
                            return yScale(c.values[index].n);
                        });
                    //...

                    
                }

                // find location in 'array' with
                // date nearest to 'date'
                var findIndex = function(array, date) {
                    var found = false;
                    var index = 1;
                    while (!found && index < array.length ) {
                        if(array[index].date > date) {
                            found = true;
                        } else {
                            index++;
                        }
                    }

                    return index - 1;
                };

                //create bisector
                // (binary search)
                var bisect = d3.bisector(function(d) { return d.date; })
                    .left;
            });
        </script>        
    </body>
</html>