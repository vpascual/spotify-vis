<html>
    <title>Small Multiples by OneTandem</title>
    <head>
        <meta name="author" content="Victor Pascual">
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <style>
            .chart {
                float: left;
                padding-right: 0px;
                padding-bottom: 0px;
                padding-top: 0;
                padding-bottom: 0;
                border: 1px solid #eee;
            }

            .background {
                fill: white;
            }

            .area {
                fill: #cec6b9;
            }

            .line {
                fill: none;
                stroke: #74736c;
                stroke-width: 1.4px;
            }
        </style>
    </head>
    <body>
        <div id='vis'></div>
        <script>
            var width = 200,
                height = 200,
                margin = {top: 0, bottom: 20, left: 30, right: 0};

            d3.tsv("danceability.tsv", function(rawData) {
                console.log(rawData);
                rawData.forEach((d) => {
                   d.danceability = +d.danceability;
                   d.value = d.value.replace(',', '.');
                   d.value = +d.value;
                });

                var maxDancebility = d3.max(rawData, (d) => { return d.value; });

                data = d3.nest()
                    .key(function(d) { return d.band; })
                    .sortValues((a, b) => {
                        return d3.ascending(a.danceability, b.danceability);
                    })
                    .entries(rawData);

                var div = d3.select("#vis")
                    .selectAll(".chart")
                    .data(data);

                var svg = div.enter()
                    .append('div')
                    .attr('class', 'chart')
                    .append('svg')
                        .attr('width', width + margin.left + margin.top)
                        .attr('height', height + margin.top + margin.bottom);
                    
                var g = svg.append('g')
                    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');                

                g.append('rect')
                    .attr('class', 'background')
                    .style('pointer-events', 'all')
                    .attr('width', width + margin.right)
                    .attr('height', height)
                    .on("mouseover", mouseover)
                    .on("mousemove", mousemove)
                    .on("mouseout", mouseout);

                var xScale = d3.scaleLinear().range([0, width]);
                var yScale = d3.scaleLinear().range([height, 0]).domain([0, maxDancebility * 1.1]);

                g.append("g")
                    .call(d3.axisLeft(yScale));

                g.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(xScale));

                var line = d3.line()
                    .x(function(d) { return xScale(d.danceability); })
                    .y(function(d) { return yScale(d.value); });

                var area = d3.area()
                    .x(function(d) { 
                        return xScale(d.danceability); })
                    .y0(height).y1(function(d) { 
                        return yScale(d.value); });

                lines = g.append("g")
                    .on("mouseover", mouseover)
                    .on("mousemove", mousemove)
                    .on("mouseout", mouseout);

                lines.append("path")
                    .attr("class", "area")
                    .attr("d", function(c) {
                        return area(c.values);
                    });

                lines.append("path")
                    .attr("class", "line")
                    .attr("d", function(c) {
                        return line(c.values);
                    });

                // hide for now
                circle = lines.append("circle")
                    .attr("r", 2.2)
                    .attr("opacity", 0);

                function mouseover() {
                    circle.attr("opacity", 1.0);
                };

                function mouseout() {
                    circle.attr("opacity", 0);
                    return true;
                };

                function mousemove() {
                    // 'this' is current DOM element
                    var xpos = d3.mouse(this)[0];
                    var xBar = xScale.invert(xpos);
                    var index = 0;

                    circle
                        .attr("cx", (c) => {
                            index = bisect(c.values, xBar, 0, c.values.length - 1);
                            return xScale(c.values[index].danceability);
                        })
                        .attr("cy", (c) => {
                            index = bisect(c.values, xBar, 0, c.values.length - 1);
                            return yScale(c.values[index].value);
                        });
                }

                //create bisector
                // (binary search)
                var bisect = d3.bisector(function(d) { return d.danceability; }).left;
            });
        </script>        
</html